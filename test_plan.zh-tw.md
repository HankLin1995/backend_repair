# 測試計畫

本文件概述了後端缺失管理系統的測試策略和流程。

## 1. 測試框架

本專案使用 `pytest` 作為撰寫和執行測試的主要框架，用於應用程式元件的單元測試和整合測試。

## 2. 測試環境

測試在一個盡可能模擬生產環境的受控環境中執行，包括：

- **測試資料庫**：使用一個獨立的記憶體中 SQLite 資料庫進行測試，以確保測試是隔離的，且不會影響開發或生產資料庫。
- **測試客戶端**：使用 FastAPI 的 `TestClient` 向 API 端點發出請求，模擬真實世界的客戶端互動。
- **Fixtures**：廣泛使用 `pytest` 的 fixtures 為測試提供一致且可重複使用的設定。這包括建立測試所需的資料，如使用者、專案、缺失等。

## 3. 測試覆蓋範圍

每個模組的測試流程分為兩大類：**CRUD 測試**和 **API 測試**。

### 3.1. CRUD 測試

這些測試專注於資料存取層，特別是每個模組中的 `crud.py` 檔案。目標是確保在資料庫中建立、讀取、更新和刪除記錄的功能正常運作。

針對每個模型，測試以下操作：

- **建立 (Create)**：驗證可以使用有效資料建立新記錄。
- **讀取 (Read)**：驗證可以檢索現有記錄，包括單一記錄和列表，同時也測試任何篩選功能。
- **更新 (Update)**：驗證可以使用新資料更新現有記錄。
- **刪除 (Delete)**：驗證可以成功從資料庫中刪除記錄。

### 3.2. API 測試

這些測試專注於每個模組 `routers.py` 檔案中定義的 API 端點。目標是確保 API 按預期運作，包括請求處理、資料驗證和回應生成。

針對每個端點，測試以下方面：

- **成功請求**：驗證端點對於有效請求能回傳正確的狀態碼（例如 `200 OK`, `201 Created`）和回應主體。
- **錯誤處理**：驗證端點對於無效或格式錯誤的請求能回傳適當的錯誤狀態碼（例如 `404 Not Found`, `422 Unprocessable Entity`）。
- **身份驗證和授權**：對於需要驗證的端點，驗證存取權限是否根據使用者角色和權限被正確限制。

### 3.3. 模組特定測試計畫

- **使用者管理 (`test_user*.py`)**：
    - `User` 模型的 CRUD 測試。
    - 使用者建立、檢索、更新和刪除的 API 測試。
    - 檢索使用者關聯專案的測試。
    - 頭像上傳和路徑管理的測試。
    - 使用者資料的驗證測試（例如，電子郵件格式、必填欄位）。
    - 使用者更新的邊界案例測試（例如，空資料、部分更新）。

- **專案管理 (`test_project.py`)**：
    - `Project` 模型的 CRUD 測試。
    - 專案建立、檢索、更新和刪除的 API 測試。
    - 專案圖片上傳的測試。

- **權限管理 (`test_permission.py`)**：
    - `Permission` 模型的 CRUD 測試。
    - 建立、檢索、更新和刪除權限的 API 測試。
    - 按專案和使用者檢索權限的測試。

- **缺失管理 (`test_defect.py`)**：
    - `Defect` 模型的 CRUD 測試。
    - 缺失建立、檢索、更新和刪除的 API 測試。
    - 根據各種標準篩選缺失的測試。
    - 檢索缺失統計資料的測試。
    - 狀態轉換以及與其他模型（如改善建議）關聯的測試。

- **缺失類別管理 (`test_defect_category.py`)**：
    - `DefectCategory` 模型的 CRUD 測試。
    - 類別建立、檢索、更新和刪除的 API 測試。
    - 檢索帶有缺失數量的類別的測試。

- **廠商管理 (`test_vendor.py`)**：
    - `Vendor` 模型的 CRUD 測試。
    - 廠商建立、檢索、更新和刪除的 API 測試。
    - 檢索帶有缺失數量的廠商的測試。

- **照片管理 (`test_photo.py`)**：
    - `Photo` 模型的 CRUD 測試。
    - 照片檢索、更新和刪除的 API 測試。
    - 照片上傳及與其他模型（如缺失）關聯的測試。

- **改善與確認 (`test_improvement.py`, `test_confirmation.py`)**：
    - `Improvement` 和 `Confirmation` 模型的 CRUD 和 API 測試。
    - 缺失、改善和確認之間關聯的測試。

- **底圖管理 (`test_base_map.py`)**：
    - `BaseMap` 模型的 CRUD 和 API 測試。
    - 檢索帶有缺失數量的底圖的測試。

## 4. 如何執行測試

若要執行整個測試套件，請在專案的根目錄下執行以下指令：

```bash
pytest
```

## TODOLIST

### 多餘的測試 (待移除或整合)

- **`test_defect.py`**：
    - `test_get_defect_with_marks_and_photos`：此測試已棄用，其功能已由 `test_get_defect_details` 涵蓋，應予以移除。
- **`test_permission.py`**：
    - `test_api_create_permission_invalid_user`：此測試已被註解，應進行審查。若邏輯仍然相關，應重新啟用；否則應予以移除。
- **`test_photo.py`**：
    - `test_create_photo` 和 `test_api_create_photo`：這些測試已被註解，其功能可能已由檔案上傳測試涵蓋，應予以移除。
- **`test_project.py`**：
    - `test_api_upload_project_image_crop_size`：此測試已被註解，應進行審查。若仍需要圖片裁切功能，應重新啟用此測試；否則應予以移除。
- **`test_user_project_relation.py`**：
    - `test_permission_with_non_existent_user`：此測試已被註解，應進行審查後重新啟用或移除。
- **使用者測試檔案**：
    - 使用者相關的測試分散在多個檔案中 (`test_user.py`, `test_user_avatar.py`, `test_user_project_relation.py`, `test_user_update_edge_cases.py`, `test_user_validation.py`)。為了更好的組織性，應將這些測試整合到單一的 `test_user.py` 檔案中。

### 欠缺的測試 (待新增)

- **身份驗證與授權**：
    - 雖然部分測試隱含地處理了授權（例如 `test_api_update_improvement_unauthorized`），但缺乏對基於角色的存取控制的系統性測試。應新增測試以驗證不同角色（管理員、編輯者、檢視者）的使用者對於各種操作是否具有正確的權限。
- **資料驗證**：
    - 需要更全面的資料驗證測試。例如，測試字串欄位的最大長度、數值欄位的有效範圍以及其他約束條件。
- **併發與競爭條件**：
    - 目前沒有處理併發請求或潛在競爭條件的測試，這在多使用者環境中可能很重要。
- **效能與可擴展性**：
    - 目前沒有效能或負載測試。雖然並非所有專案都必須，但增加一些基本的效能基準測試將會很有幫助。
- **缺失標記模組 (`defect_mark`)**：
    - `defect_mark` 模組沒有任何測試。應為其 CRUD 操作和 API 端點建立測試。
